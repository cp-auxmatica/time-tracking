<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .container { max-width: 1200px; }
        .timer-display { font-variant-numeric: tabular-nums; }
        .project-card { transition: all 0.2s ease-in-out; }
        .project-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
        .report-filter-btn.active { background-color: #3B82F6; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <div class="container mx-auto">
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-50">Time Tracker</h1>
            <div class="flex space-x-2">
                <button id="dashboard-btn" class="px-3 py-2 font-semibold text-gray-200 rounded-lg hover:bg-gray-700 transition-colors active bg-gray-700">Dashboard</button>
                <button id="reports-btn" class="px-3 py-2 font-semibold text-gray-200 rounded-lg hover:bg-gray-700 transition-colors">Reports</button>
            </div>
        </header>

        <section id="dashboard-section" class="block">
            <div class="mb-8 p-4 rounded-xl bg-gray-800 border border-gray-700 text-gray-50 shadow-lg flex justify-between items-center">
                <div>
                    <h3 class="text-lg sm:text-xl font-bold">Today's Time</h3>
                    <p class="text-xl sm:text-2xl font-semibold"><span id="todays-hours">0.00</span> hours</p>
                </div>
                <div class="text-right">
                    <h3 class="text-lg sm:text-xl font-bold">Current Time</h3>
                    <p class="text-xl sm:text-2xl font-semibold timer-display" id="current-time">00:00:00</p>
                </div>
            </div>

            <div class="mb-8">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Your Projects</h2>
                    <button id="add-project-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold h-10 w-10 flex items-center justify-center rounded-full transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </button>
                 </div>
                 <div id="dashboard-projects-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
            </div>
            
            <div>
                <h2 class="text-2xl font-bold mb-4">Today's Log</h2>
                <div id="todays-log-list" class="space-y-3">
                    </div>
            </div>
        </section>

        <section id="reports-section" class="hidden">
            <h2 class="text-3xl font-bold mb-4">Reports</h2>
            <div class="flex space-x-2 mb-6 p-2 bg-gray-800 rounded-lg border border-gray-700 w-full sm:w-auto">
                <button class="report-filter-btn flex-grow sm:flex-grow-0 px-4 py-2 rounded-md font-semibold transition-colors active" data-period="day">Today</button>
                <button class="report-filter-btn flex-grow sm:flex-grow-0 px-4 py-2 rounded-md font-semibold transition-colors" data-period="week">This Week</button>
                <button class="report-filter-btn flex-grow sm:flex-grow-0 px-4 py-2 rounded-md font-semibold transition-colors" data-period="month">This Month</button>
            </div>
            <div id="report-output">
                </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State ---
        let projects = [];
        let tasks = [];
        let activeTimer = null;
        let timerInterval = null;
        const projectColors = ['#3B82F6', '#10B981', '#F97316', '#8B5CF6', '#EF4444', '#F9A825', '#EC4899', '#6366F1'];
        
        // --- DOM Element Cache ---
        const elements = {
            dashboardBtn: document.getElementById('dashboard-btn'),
            reportsBtn: document.getElementById('reports-btn'),
            dashboardSection: document.getElementById('dashboard-section'),
            reportsSection: document.getElementById('reports-section'),
            todaysHours: document.getElementById('todays-hours'),
            currentTimeDisplay: document.getElementById('current-time'),
            dashboardProjectsList: document.getElementById('dashboard-projects-list'),
            todaysLogList: document.getElementById('todays-log-list'),
            addProjectBtn: document.getElementById('add-project-btn'),
            reportOutput: document.getElementById('report-output'),
        };

        // --- Helper Functions ---
        const formatTime = (milliseconds) => {
            if (isNaN(milliseconds) || milliseconds < 0) return "00:00:00";
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        const formatCurrentTime = () => {
            elements.currentTimeDisplay.textContent = new Date().toLocaleTimeString('en-US');
        };

        // --- IndexedDB ---
        let db;
        const openDB = () => new Promise((resolve) => {
            const request = indexedDB.open('timeTrackerDB', 8);
            request.onupgradeneeded = e => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('tasks')) {
                    const tasksStore = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                    tasksStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            request.onsuccess = e => { db = e.target.result; resolve(db); };
        });
        const addData = (storeName, data) => new Promise((resolve) => {
            db.transaction(storeName, 'readwrite').objectStore(storeName).add(data).onsuccess = e => resolve(e.target.result);
        });
        const getAllData = (storeName) => new Promise((resolve) => {
            db.transaction(storeName, 'readonly').objectStore(storeName).getAll().onsuccess = e => resolve(e.target.result);
        });

        // --- Data & State Management ---
        const loadData = async () => {
            await openDB();
            [projects, tasks] = await Promise.all([getAllData('projects'), getAllData('tasks')]);
            renderAllDashboard();
        };
        
        const checkPersistentTimer = () => {
            const savedTimer = localStorage.getItem('activeTimerState');
            if (savedTimer) {
                activeTimer = JSON.parse(savedTimer);
                startTimerInterval();
            }
        };

        // --- Core Application Logic ---
        const startTimer = (projectId) => {
            const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
            const description = card.querySelector('.task-description-input').value.trim() || 'Untitled Task';

            if(activeTimer) {
                alert('Another timer is already running. Please stop it first.');
                return;
            }

            activeTimer = { projectId, description, startTime: Date.now() };
            localStorage.setItem('activeTimerState', JSON.stringify(activeTimer));
            startTimerInterval();
            renderDashboardProjects();
        };

        const stopTimer = async () => {
            if (!activeTimer) return;
            const { projectId, description, startTime } = activeTimer;
            const task = { projectId, description, duration: Date.now() - startTime, timestamp: Date.now() };
            
            tasks.push({ ...task, id: await addData('tasks', task) });

            localStorage.removeItem('activeTimerState');
            activeTimer = null;
            stopTimerInterval();
            renderAllDashboard();
        };
        
        const addProject = async () => {
            const name = prompt("Enter new project name:");
            if (name && name.trim()) {
                const newProject = { 
                    name: name.trim(), 
                    isComplete: false,
                    color: projectColors[projects.length % projectColors.length]
                };
                projects.push({ ...newProject, id: await addData('projects', newProject) });
                renderAllDashboard();
            }
        };

        const startTimerInterval = () => {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (activeTimer) {
                    const timerDisplay = document.getElementById(`timer-display-${activeTimer.projectId}`);
                    if (timerDisplay) timerDisplay.textContent = formatTime(Date.now() - activeTimer.startTime);
                }
            }, 1000);
        };
        
        const stopTimerInterval = () => {
            clearInterval(timerInterval);
            timerInterval = null;
        };

        // --- UI Rendering Functions ---
        const renderAllDashboard = () => {
            renderDashboardProjects();
            updateTodaysMetrics();
            renderTodaysLog();
        };

        const updateTodaysMetrics = () => {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const totalTimeInMillis = tasks
                .filter(task => task.timestamp >= startOfDay)
                .reduce((sum, task) => sum + task.duration, 0);
            elements.todaysHours.textContent = (totalTimeInMillis / 3600000).toFixed(2);
        };
        
        const renderDashboardProjects = () => {
            const activeProjects = projects.filter(p => !p.isComplete);
            elements.dashboardProjectsList.innerHTML = activeProjects.map(project => {
                const isRunning = activeTimer && activeTimer.projectId === project.id;
                const buttonHTML = isRunning
                    ? `<button class="stop-timer-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-b-lg transition-colors">Stop</button>`
                    : `<button class="start-timer-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-b-lg transition-colors" data-project-id="${project.id}">Start</button>`;
                
                return `
                    <div class="project-card bg-gray-800 rounded-lg shadow-lg flex flex-col border-2 ${isRunning ? 'border-yellow-400' : 'border-gray-700'}" data-project-id="${project.id}">
                        <div class="p-4 flex-grow">
                            <h3 class="font-bold text-xl mb-2">${project.name}</h3>
                            <p id="timer-display-${project.id}" class="text-4xl font-bold timer-display mb-3 ${isRunning ? 'text-yellow-400' : 'text-gray-500'}">
                                ${isRunning ? formatTime(Date.now() - activeTimer.startTime) : '00:00:00'}
                            </p>
                            <input type="text" placeholder="What are you working on?" 
                                   class="task-description-input w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   ${isRunning ? `value="${activeTimer.description}" disabled` : ''}>
                        </div>
                        ${buttonHTML}
                    </div>
                `;
            }).join('') || `<p class="text-gray-500 col-span-full">No active projects found. Click the '+' button to add one.</p>`;
        };

        const renderTodaysLog = () => {
            const startOfDay = new Date().setHours(0, 0, 0, 0);
            const todaysTasks = tasks.filter(t => t.timestamp >= startOfDay).sort((a, b) => b.timestamp - a.timestamp);

            if (todaysTasks.length === 0) {
                elements.todaysLogList.innerHTML = `<p class="text-gray-500 text-center bg-gray-800 p-4 rounded-lg">No time logged yet today.</p>`;
                return;
            }

            elements.todaysLogList.innerHTML = todaysTasks.map(task => {
                const project = projects.find(p => p.id === task.projectId);
                return `
                    <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between border-l-4" style="border-color: ${project?.color || '#71717a'};">
                        <div>
                            <p class="font-semibold text-white">${task.description}</p>
                            <p class="text-sm text-gray-400">${project?.name || 'Unknown'}</p>
                        </div>
                        <span class="font-semibold text-lg timer-display">${formatTime(task.duration)}</span>
                    </div>
                `;
            }).join('');
        };

        // --- Report Generation ---
        const generateReport = (period) => {
            const now = new Date();
            let startDate, endDate = now;

            if (period === 'day') {
                startDate = new Date(now).setHours(0, 0, 0, 0);
            } else if (period === 'week') {
                const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                startDate = firstDayOfWeek.setHours(0, 0, 0, 0);
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1).setHours(0, 0, 0, 0);
            }

            const filteredTasks = tasks.filter(t => t.timestamp >= startDate && t.timestamp <= endDate);
            
            if (filteredTasks.length === 0) {
                elements.reportOutput.innerHTML = `<p class="text-gray-500 text-center bg-gray-800 p-6 rounded-lg">No data for this period.</p>`;
                return;
            }

            const grandTotal = filteredTasks.reduce((sum, t) => sum + t.duration, 0);
            const reportData = {};

            filteredTasks.forEach(task => {
                if (!reportData[task.projectId]) {
                    const project = projects.find(p => p.id === task.projectId);
                    reportData[task.projectId] = {
                        name: project?.name || 'Unknown Project',
                        color: project?.color || '#71717a',
                        totalDuration: 0,
                        entries: []
                    };
                }
                reportData[task.projectId].totalDuration += task.duration;
                reportData[task.projectId].entries.push(task);
            });

            let reportHTML = `
                <div class="bg-blue-900/50 p-6 rounded-xl border border-blue-500 shadow mb-6">
                    <h3 class="text-2xl font-bold text-blue-300">Grand Total for ${period.charAt(0).toUpperCase() + period.slice(1)}</h3>
                    <p class="text-4xl font-bold text-white">${formatTime(grandTotal)}</p>
                </div>
            `;
            
            for (const projectId in reportData) {
                const data = reportData[projectId];
                data.entries.sort((a,b) => b.timestamp - a.timestamp); // Sort entries for display
                reportHTML += `
                    <div class="bg-gray-800 rounded-lg mb-6 border-t-4" style="border-color: ${data.color};">
                        <header class="p-4 flex justify-between items-center border-b border-gray-700">
                            <h4 class="text-xl font-bold">${data.name}</h4>
                            <span class="text-2xl font-semibold timer-display">${formatTime(data.totalDuration)}</span>
                        </header>
                        <div class="p-4 space-y-3">
                            ${data.entries.map(entry => `
                                <div class="flex justify-between items-center bg-gray-900/50 p-3 rounded-md">
                                    <div>
                                        <p>${entry.description}</p>
                                        <p class="text-xs text-gray-400">${new Date(entry.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    <span class="font-mono">${formatTime(entry.duration)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            elements.reportOutput.innerHTML = reportHTML;
        };

        // --- Event Handlers ---
        elements.dashboardBtn.addEventListener('click', () => {
            elements.dashboardSection.classList.remove('hidden');
            elements.reportsSection.classList.add('hidden');
            elements.dashboardBtn.classList.add('active', 'bg-gray-700');
            elements.reportsBtn.classList.remove('active', 'bg-gray-700');
            renderAllDashboard();
        });

        elements.reportsBtn.addEventListener('click', () => {
            elements.reportsSection.classList.remove('hidden');
            elements.dashboardSection.classList.add('hidden');
            elements.reportsBtn.classList.add('active', 'bg-gray-700');
            elements.dashboardBtn.classList.remove('active', 'bg-gray-700');
            generateReport('day'); // Default to daily report
        });
        
        elements.addProjectBtn.addEventListener('click', addProject);

        document.addEventListener('click', (e) => {
            if (e.target.matches('.start-timer-btn')) startTimer(parseInt(e.target.dataset.projectId));
            if (e.target.matches('.stop-timer-btn')) stopTimer();
            if (e.target.matches('.report-filter-btn')) {
                document.querySelectorAll('.report-filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                generateReport(e.target.dataset.period);
            }
        });
        
        // --- Initialization ---
        const initializeApp = () => {
            checkPersistentTimer();
            loadData();
            setInterval(formatCurrentTime, 1000);
        };
        
        initializeApp();
    });
    </script>
</body>
</html>
