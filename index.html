<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for better visual appeal */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .container {
            max-width: 1200px;
        }
        .tab-button.active {
            border-color: #2563eb;
            color: #2563eb;
        }
        .timer-display {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 text-gray-800">

    <div class="container mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg">

        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-900 mb-6">Time Tracker</h1>

        <!-- Tab Navigation -->
        <nav class="flex justify-center border-b border-gray-200 mb-8 overflow-x-auto whitespace-nowrap">
            <button class="tab-button px-4 py-3 sm:px-6 font-semibold text-gray-600 border-b-2 border-transparent transition-all hover:text-blue-600 hover:border-blue-300 rounded-t-lg active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button px-4 py-3 sm:px-6 font-semibold text-gray-600 border-b-2 border-transparent transition-all hover:text-blue-600 hover:border-blue-300 rounded-t-lg" data-tab="projects">Projects & Tasks</button>
            <button class="tab-button px-4 py-3 sm:px-6 font-semibold text-gray-600 border-b-2 border-transparent transition-all hover:text-blue-600 hover:border-blue-300 rounded-t-lg" data-tab="clients">Clients</button>
            <button class="tab-button px-4 py-3 sm:px-6 font-semibold text-gray-600 border-b-2 border-transparent transition-all hover:text-blue-600 hover:border-blue-300 rounded-t-lg" data-tab="reports">Reports</button>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="tab-content">
            <!-- Active Timer display moved to the top of the dashboard section for prominence -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                <h2 class="text-2xl font-bold mb-4 text-center">Active Timer</h2>
                <div id="active-timer-card" class="hidden text-center p-4 bg-white rounded-lg border border-blue-400">
                    <p class="text-lg text-gray-600">
                        <span id="timer-project-name" class="font-semibold text-blue-600"></span>
                        <span class="mx-1 text-gray-400">/</span>
                        <span id="timer-task-name" class="text-gray-500"></span>
                    </p>
                    <p id="timer-display" class="timer-display text-5xl sm:text-6xl font-extrabold text-gray-900 mt-2 mb-4">00:00:00</p>
                    <button id="stop-timer-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div id="no-active-timer-card" class="text-center text-gray-500 p-4">
                    <p class="text-lg">No active timer. Start one from your projects below!</p>
                </div>
            </div>
            
            <h2 class="text-2xl font-bold mb-4">Your Active Projects</h2>
            <div id="dashboard-projects-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Active Projects as small cards will be rendered here -->
            </div>

            <div class="bg-gray-50 p-6 rounded-xl shadow-inner mt-8">
                <h2 class="text-2xl font-bold mb-4">Add Manual Time</h2>
                <form id="manual-time-form" class="space-y-4">
                    <div>
                        <label for="manual-project-select" class="block text-sm font-medium text-gray-700">Project</label>
                        <select id="manual-project-select" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition px-4 py-2"></select>
                    </div>
                    <div>
                        <label for="manual-task-description" class="block text-sm font-medium text-gray-700">Task Description</label>
                        <input type="text" id="manual-task-description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition px-4 py-2">
                    </div>
                    <div>
                        <label for="manual-minutes" class="block text-sm font-medium text-gray-700">Minutes Spent</label>
                        <input type="number" id="manual-minutes" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition px-4 py-2">
                    </div>
                    <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Add Time</button>
                </form>
            </div>
            
        </section>

        <!-- Projects & Tasks Section -->
        <section id="projects" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Add New Project</h2>
            <form id="add-project-form" class="space-y-4 bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700">Project Name</label>
                    <input type="text" id="project-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2">
                </div>
                <div>
                    <label for="project-client" class="block text-sm font-medium text-gray-700">Client</label>
                    <select id="project-client" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2"></select>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Add Project</button>
            </form>

            <div class="mt-8 flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Your Projects</h2>
                <button id="toggle-completed-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-md hover:bg-gray-300 transition-colors text-sm">View Completed Projects</button>
            </div>
            <div id="projects-list">
                <!-- Projects will be rendered here -->
            </div>
        </section>

        <!-- Clients Section -->
        <section id="clients" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Add New Client</h2>
            <form id="add-client-form" class="space-y-4 bg-gray-50 p-6 rounded-xl shadow-inner">
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                    <input type="text" id="client-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2">
                </div>
                <div>
                    <label for="client-details" class="block text-sm font-medium text-gray-700">Details</label>
                    <textarea id="client-details" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2"></textarea>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Add Client</button>
            </form>

            <div class="mt-8">
                <h2 class="text-xl font-bold mb-4">Your Clients</h2>
                <div id="clients-list">
                    <!-- Clients will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Generate Report</h2>
            <form id="report-form" class="space-y-4 bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                <div>
                    <label for="report-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="report-start-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2">
                </div>
                <div>
                    <label for="report-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="report-end-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out px-4 py-2">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Generate Report</button>
            </form>

            <div id="report-output">
                <!-- Report will be displayed here -->
            </div>

            ---

            <div class="mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="export-json-btn" class="w-full sm:w-1/2 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Export All Data as JSON</button>
                <button id="export-csv-btn" class="w-full sm:w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">Export Time Log as CSV</button>
            </div>
        </section>
        
        <!-- Modal for Alerts -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden transition-opacity z-50"></div>
        <div id="modal-container" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50">
            <div id="modal" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all scale-95 opacity-0">
                <div class="text-lg font-semibold text-gray-800 mb-4" id="modal-title"></div>
                <div class="text-sm text-gray-600 mb-6" id="modal-message"></div>
                <div class="flex justify-end space-x-2">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">OK</button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Modal/Alert Functionality ---
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            function showAlert(message, title = 'Alert', type = 'alert', onConfirm = () => {}, onCancel = () => {}) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalBackdrop.classList.remove('hidden');
                modalContainer.classList.remove('hidden');
                modal.classList.add('scale-100', 'opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');

                if (type === 'confirm') {
                    modalConfirmBtn.classList.remove('hidden');
                    modalCancelBtn.classList.remove('hidden');
                } else {
                    modalConfirmBtn.classList.add('hidden');
                    modalCancelBtn.classList.add('hidden');
                }

                modalConfirmBtn.onclick = () => {
                    onConfirm();
                    closeModal();
                };
                modalCancelBtn.onclick = () => {
                    onCancel();
                    closeModal();
                };
            }

            function closeModal() {
                modal.classList.remove('scale-100', 'opacity-100');
                modal.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                    modalContainer.classList.add('hidden');
                }, 300);
            }

            // A simpler function to display a quick message
            function showMessage(message, title = 'Notification') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = 'OK';
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.add('hidden');
                modalBackdrop.classList.remove('hidden');
                modalContainer.classList.remove('hidden');
                modal.classList.add('scale-100', 'opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
                modalConfirmBtn.onclick = closeModal;
            }

            // --- IndexedDB Database Operations ---
            const DB_NAME = 'timeTrackerDB';
            const DB_VERSION = 2; // Increased version for schema change
            let db;

            const openDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains('projects')) {
                            db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('tasks')) {
                            const tasksStore = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                            tasksStore.createIndex('projectId', 'projectId', { unique: false });
                            tasksStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('clients')) {
                            db.createObjectStore('clients', { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };

                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.errorCode);
                        reject('IndexedDB error');
                    };
                });
            };

            const addData = (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error adding data');
                });
            };

            const getAllData = (storeName) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error getting all data');
                });
            };
            
            const updateData = (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error updating data');
                });
            };

            const deleteData = (storeName, id) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error deleting data');
                });
            };

            // --- State and Variables ---
            let clients = [];
            let projects = [];
            let activeTimer = null;
            let timerInterval = null;
            let timerStartTime = 0;
            let showingCompletedProjects = false; // State to track which projects to show

            const elements = {
                // Tabs
                tabButtons: document.querySelectorAll('.tab-button'),
                tabContents: document.querySelectorAll('.tab-content'),
                // Dashboard
                dashboardProjectsList: document.getElementById('dashboard-projects-list'),
                activeTimerCard: document.getElementById('active-timer-card'),
                noActiveTimerCard: document.getElementById('no-active-timer-card'),
                timerProjectName: document.getElementById('timer-project-name'),
                timerTaskName: document.getElementById('timer-task-name'),
                timerDisplay: document.getElementById('timer-display'),
                stopTimerBtn: document.getElementById('stop-timer-btn'),
                manualTimeForm: document.getElementById('manual-time-form'),
                manualProjectSelect: document.getElementById('manual-project-select'),
                manualTaskDescription: document.getElementById('manual-task-description'),
                manualMinutes: document.getElementById('manual-minutes'),
                // Projects
                addProjectForm: document.getElementById('add-project-form'),
                projectsList: document.getElementById('projects-list'),
                projectClientSelect: document.getElementById('project-client'),
                toggleCompletedBtn: document.getElementById('toggle-completed-btn'),
                // Clients
                addClientForm: document.getElementById('add-client-form'),
                clientsList: document.getElementById('clients-list'),
                // Reports
                reportForm: document.getElementById('report-form'),
                reportOutput: document.getElementById('report-output'),
                exportJsonBtn: document.getElementById('export-json-btn'),
                exportCsvBtn: document.getElementById('export-csv-btn'),
            };

            // --- UI Rendering Functions ---

            const renderClients = (clients) => {
                elements.clientsList.innerHTML = clients.length === 0 
                    ? '<p class="text-gray-500">No clients added yet.</p>'
                    : clients.map(client => `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center mb-2">
                            <div>
                                <h3 class="font-semibold text-gray-900">${client.name}</h3>
                                <p class="text-sm text-gray-500">${client.details}</p>
                            </div>
                            <button class="delete-btn text-red-500 hover:text-red-700 font-bold p-2" data-id="${client.id}" data-type="client">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `).join('');
                
                // Update client dropdown in projects form
                elements.projectClientSelect.innerHTML = clients.length === 0 
                    ? '<option value="">No clients available</option>'
                    : '<option value="">Select a Client</option>' + clients.map(client => `
                        <option value="${client.id}">${client.name}</option>
                    `).join('');
            };

            const renderProjects = async () => {
                projects = await getAllData('projects');
                const projectsToRender = showingCompletedProjects ? projects.filter(p => p.isComplete) : projects.filter(p => !p.isComplete);
                
                elements.toggleCompletedBtn.textContent = showingCompletedProjects ? 'View Active Projects' : 'View Completed Projects';

                const projectsHTML = projectsToRender.map(project => {
                    const client = clients.find(c => c.id === project.clientId);
                    return `
                        <div class="project-card bg-white p-6 rounded-xl shadow-md border-t-4 ${project.isComplete ? 'border-gray-400' : 'border-blue-500'} mb-6">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                                <div>
                                    <h3 class="text-xl font-bold ${project.isComplete ? 'text-gray-600 line-through' : 'text-blue-800'}">${project.name}</h3>
                                    <p class="text-sm text-gray-500">Client: ${client ? client.name : 'N/A'}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${project.isComplete
                                        ? `<button class="restore-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105 text-sm" data-id="${project.id}">Restore</button>`
                                        : `<button class="complete-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105 text-sm" data-id="${project.id}">Complete</button>`
                                    }
                                    <button class="delete-btn text-red-500 hover:text-red-700 font-bold p-2" data-id="${project.id}" data-type="project">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            ${!project.isComplete ? `
                            <h4 class="font-semibold text-gray-700 text-lg mb-2">Tasks</h4>
                            <div class="space-y-4" data-project-id="${project.id}">
                                <!-- Tasks for this project will be rendered here -->
                            </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                elements.projectsList.innerHTML = projectsToRender.length === 0
                    ? `<p class="text-gray-500 text-center">No ${showingCompletedProjects ? 'completed' : 'active'} projects found.</p>`
                    : projectsHTML;
                
                // Render dashboard projects only if not showing completed projects
                if (!showingCompletedProjects) {
                    renderDashboardProjects();
                } else {
                    elements.dashboardProjectsList.innerHTML = '';
                }
                
                // Re-attach event listeners for dynamic content
                projectsToRender.forEach(project => renderProjectTasks(project.id));
            };

            const renderDashboardProjects = () => {
                const activeProjects = projects.filter(p => !p.isComplete);
                const dashboardHTML = activeProjects.map(project => {
                    const client = clients.find(c => c.id === project.clientId);
                    const clientName = client ? client.name : 'N/A';
                    return `
                        <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 flex flex-col justify-between aspect-square w-full">
                            <div>
                                <h3 class="font-bold text-lg text-blue-800">${project.name}</h3>
                                <p class="text-sm text-gray-500">${clientName}</p>
                            </div>
                            <form class="start-timer-form mt-4 space-y-2 flex-grow flex flex-col justify-end">
                                <div>
                                    <input type="text" placeholder="Task description" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition px-3 py-2">
                                </div>
                                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-md shadow transition-transform transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 3l14 9-14 9V3z"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    `;
                }).join('');
                elements.dashboardProjectsList.innerHTML = dashboardHTML || '<p class="text-gray-500 text-center">No active projects to display. Please add one in the "Projects & Tasks" tab.</p>';

                // Update manual time form project options
                elements.manualProjectSelect.innerHTML = activeProjects.length === 0 
                    ? '<option value="">No projects available</option>'
                    : '<option value="">Select a Project</option>' + activeProjects.map(project => `
                        <option value="${project.id}">${project.name}</option>
                    `).join('');
            };

            const renderProjectTasks = async (projectId) => {
                const allTasks = await getAllData('tasks');
                const projectTasks = allTasks.filter(task => task.projectId === projectId);
                const taskContainer = document.querySelector(`.project-card [data-project-id="${projectId}"]`);

                if (!taskContainer) return;

                const taskHTML = projectTasks.map(task => {
                    const durationText = formatTime(task.duration);
                    
                    return `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 mb-2">
                            <div class="flex-grow w-full">
                                <p class="font-semibold text-gray-900 break-words">${task.description}</p>
                                <p class="text-sm text-gray-500">Duration: ${durationText}</p>
                                <p class="text-xs text-gray-400">Date: ${new Date(task.timestamp).toLocaleDateString()}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                <button class="delete-task-btn text-red-500 hover:text-red-700 font-bold p-2" data-task-id="${task.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                taskContainer.innerHTML = taskHTML || '<p class="text-gray-500">No tasks logged yet.</p>';
            };

            const formatTime = (milliseconds) => {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };

            const updateTimerDisplay = () => {
                if (activeTimer) {
                    const elapsed = Date.now() - timerStartTime;
                    elements.timerDisplay.textContent = formatTime(elapsed);
                }
            };
            
            // --- Event Handlers ---

            elements.tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    elements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    elements.tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                });
            });

            elements.addClientForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('client-name').value;
                const details = document.getElementById('client-details').value;
                if (!name) {
                    showMessage('Please enter a client name.');
                    return;
                }
                await addData('clients', { name, details });
                elements.addClientForm.reset();
                await loadAllData();
                showMessage('Client added successfully!');
            });
            
            elements.addProjectForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('project-name').value;
                const clientId = parseInt(document.getElementById('project-client').value);
                if (!name || isNaN(clientId)) {
                    showMessage('Please fill out all project fields correctly.');
                    return;
                }
                await addData('projects', { name, clientId, isComplete: false });
                elements.addProjectForm.reset();
                await loadAllData();
                showMessage('Project added successfully!');
            });

            elements.toggleCompletedBtn.addEventListener('click', async () => {
                showingCompletedProjects = !showingCompletedProjects;
                await renderProjects();
            });

            elements.manualTimeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const projectId = parseInt(elements.manualProjectSelect.value);
                const description = elements.manualTaskDescription.value;
                const minutes = parseInt(elements.manualMinutes.value);

                if (!projectId || !description || isNaN(minutes) || minutes <= 0) {
                    showMessage('Please fill all fields for manual time entry.');
                    return;
                }
                
                const task = {
                    projectId,
                    description,
                    duration: minutes * 60 * 1000,
                    timestamp: Date.now()
                };
                await addData('tasks', task);
                elements.manualTimeForm.reset();
                showMessage('Manual time added successfully!');
            });

            document.addEventListener('submit', async (e) => {
                if (e.target.matches('.start-timer-form')) {
                    e.preventDefault();
                    if (activeTimer) {
                        showMessage('A timer is already running. Please stop it first.');
                        return;
                    }
                    const projectId = parseInt(e.target.closest('.start-timer-form').dataset.projectId);
                    const description = e.target.closest('.start-timer-form').querySelector('input[type="text"]').value;

                    if (!description) {
                        showMessage('Please enter a task description.');
                        return;
                    }

                    const project = projects.find(p => p.id === projectId);
                    if (!project) return;
                    
                    activeTimer = {
                        projectId,
                        description,
                        startTime: Date.now()
                    };
                    timerStartTime = activeTimer.startTime;
                    timerInterval = setInterval(updateTimerDisplay, 1000);
                    
                    elements.timerProjectName.textContent = project.name;
                    elements.timerTaskName.textContent = description;
                    elements.noActiveTimerCard.classList.add('hidden');
                    elements.activeTimerCard.classList.remove('hidden');
                    elements.timerDisplay.textContent = '00:00:00';
                }
            });

            document.addEventListener('click', async (e) => {
                if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    const id = parseInt(btn.dataset.id);
                    const type = btn.dataset.type;
                    
                    const confirmDelete = async () => {
                        await deleteData(type + 's', id);
                        await loadAllData();
                        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully.`);
                    };
                    
                    showAlert(`Are you sure you want to delete this ${type}?`, 'Confirm Deletion', 'confirm', confirmDelete);
                }

                if (e.target.closest('.delete-task-btn')) {
                    const btn = e.target.closest('.delete-task-btn');
                    const taskId = parseInt(btn.dataset.taskId);
                    const projectId = parseInt(btn.closest('.project-card').dataset.projectId);
                    await deleteData('tasks', taskId);
                    await renderProjectTasks(projectId);
                    showMessage('Task deleted successfully.');
                }
                
                if (e.target.matches('.complete-btn') || e.target.matches('.restore-btn')) {
                    const btn = e.target;
                    const projectId = parseInt(btn.dataset.id);
                    const projectToUpdate = projects.find(p => p.id === projectId);
                    if (projectToUpdate) {
                        projectToUpdate.isComplete = !projectToUpdate.isComplete;
                        await updateData('projects', projectToUpdate);
                        await renderProjects(); // Re-render the project list
                        showMessage(`Project ${projectToUpdate.isComplete ? 'completed' : 'restored'} successfully.`);
                    }
                }

                if (e.target.matches('#stop-timer-btn') || e.target.closest('#stop-timer-btn')) {
                    if (activeTimer) {
                        const duration = Date.now() - activeTimer.startTime;
                        const task = {
                            projectId: activeTimer.projectId,
                            description: activeTimer.description,
                            duration,
                            timestamp: Date.now()
                        };
                        
                        addData('tasks', task).then(() => {
                            showMessage('Time logged successfully!');
                            clearInterval(timerInterval);
                            activeTimer = null;
                            elements.activeTimerCard.classList.add('hidden');
                            elements.noActiveTimerCard.classList.remove('hidden');
                            renderProjectTasks(task.projectId);
                        });
                    }
                }
            });

            elements.reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startDate = new Date(document.getElementById('report-start-date').value);
                const endDate = new Date(document.getElementById('report-end-date').value);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    showMessage('Please select valid start and end dates.');
                    return;
                }
                
                const allTasks = await getAllData('tasks');
                const filteredTasks = allTasks.filter(task => {
                    const taskDate = new Date(task.timestamp);
                    return taskDate >= startDate && taskDate <= endDate;
                });
                
                const report = {};
                
                filteredTasks.forEach(task => {
                    const project = projects.find(p => p.id === task.projectId);
                    if (!project) return;
                    const client = clients.find(c => c.id === project.clientId);
                    
                    const clientName = client ? client.name : 'Unknown Client';
                    const projectName = project.name;
                    const durationInHours = task.duration / 3600000;
                    
                    if (!report[clientName]) {
                        report[clientName] = { totalTime: 0, projects: {} };
                    }
                    if (!report[clientName].projects[projectName]) {
                        report[clientName].projects[projectName] = { totalTime: 0, tasks: [] };
                    }
                    
                    report[clientName].totalTime += durationInHours;
                    report[clientName].projects[projectName].totalTime += durationInHours;
                    report[clientName].projects[projectName].tasks.push({ description: task.description, duration: durationInHours });
                });

                renderReport(report);
            });
            
            const renderReport = (report) => {
                let reportHTML = '';
                let grandTotalTime = 0;

                for (const clientName in report) {
                    const clientReport = report[clientName];
                    grandTotalTime += clientReport.totalTime;
                    
                    reportHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500 mb-6">
                            <h3 class="text-xl font-bold text-gray-800">${clientName}</h3>
                            <p class="text-sm text-gray-500">Total Time: ${clientReport.totalTime.toFixed(2)} hours</p>
                            
                            <div class="mt-4 space-y-4">
                                ${Object.keys(clientReport.projects).map(projectName => {
                                    const projectReport = clientReport.projects[projectName];
                                    return `
                                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                            <h4 class="font-semibold text-gray-700">${projectName}</h4>
                                            <p class="text-xs text-gray-500">Total Time: ${projectReport.totalTime.toFixed(2)} hours</p>
                                            <div class="mt-2 text-sm space-y-1">
                                                ${projectReport.tasks.map(task => `
                                                    <div class="flex justify-between items-center text-gray-600">
                                                        <span>- ${task.description}:</span>
                                                        <span class="font-medium">${task.duration.toFixed(2)} hrs</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                if (Object.keys(report).length === 0) {
                    elements.reportOutput.innerHTML = '<p class="text-gray-500 text-center">No data found for this date range.</p>';
                } else {
                    elements.reportOutput.innerHTML = `
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow mb-6 text-center">
                            <h3 class="text-2xl font-bold text-blue-800">Grand Total</h3>
                            <p class="text-lg text-gray-600">Total Time: <span class="font-semibold">${grandTotalTime.toFixed(2)} hours</span></p>
                        </div>
                        ${reportHTML}
                    `;
                }
            };

            // --- Export Functions ---
            const downloadFile = (data, filename, type) => {
                const blob = new Blob([data], { type: type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const exportDataAsJSON = async () => {
                const allData = {
                    clients: await getAllData('clients'),
                    projects: await getAllData('projects'),
                    tasks: await getAllData('tasks')
                };
                const jsonString = JSON.stringify(allData, null, 2);
                downloadFile(jsonString, 'time_tracker_data.json', 'application/json');
                showMessage('Data exported as JSON successfully!');
            };

            const exportDataAsCSV = async () => {
                // Get all data to join relationships
                const allTasks = await getAllData('tasks');
                const allProjects = await getAllData('projects');
                const allClients = await getAllData('clients');
                
                // Create mappings for quick lookup
                const projectsMap = new Map(allProjects.map(p => [p.id, p]));
                const clientsMap = new Map(allClients.map(c => [c.id, c]));

                // Define CSV header
                const headers = ['Date', 'Project', 'Client', 'Task Description', 'Duration (mins)', 'Duration (hours)'];
                let csvContent = headers.join(',') + '\n';
                
                // Populate CSV with task data
                allTasks.forEach(task => {
                    const project = projectsMap.get(task.projectId);
                    const client = project ? clientsMap.get(project.clientId) : null;
                    
                    const date = new Date(task.timestamp).toLocaleDateString();
                    const projectName = project ? project.name : 'N/A';
                    const clientName = client ? client.name : 'N/A';
                    const description = task.description.replace(/,/g, ''); // Remove commas to prevent issues
                    const durationMins = (task.duration / 60000).toFixed(2);
                    const durationHours = (task.duration / 3600000).toFixed(2);

                    const row = [date, projectName, clientName, description, durationMins, durationHours];
                    csvContent += row.join(',') + '\n';
                });
                
                downloadFile(csvContent, 'time_tracker_report.csv', 'text/csv');
                showMessage('Time log exported as CSV successfully!');
            };
            
            elements.exportJsonBtn.addEventListener('click', exportDataAsJSON);
            elements.exportCsvBtn.addEventListener('click', exportDataAsCSV);
            
            // --- Initialization ---
            const loadAllData = async () => {
                await openDB();
                clients = await getAllData('clients');
                projects = await getAllData('projects');
                renderClients(clients);
                renderProjects();
            };

            loadAllData().catch(err => {
                console.error('Failed to load data:', err);
                showMessage('Failed to initialize the application. Please check the console for details.', 'Error');
            });
        });
    </script>

</body>
</html>
